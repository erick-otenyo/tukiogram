{% extends 'base.html' %}
{% load staticfiles %}
{% block page-css %}
    <link href="{% static 'css/leaflet.css' %}" rel="stylesheet">
{% endblock page-css %}
{% block content %}
    <div id="tukio-homemap" style="width:auto; height: 100%;"></div>
{% endblock content %}
{% block page-js %}
    <script src="{% static 'js/leaflet.js' %}"></script>
    <script>
        //initialize tukio-homemap
        var map = L.map('tukio-homemap', {
            center: [-1.09713135, 37.014170107681],
            zoom: 16,
            zoomControl: false,
            closePopupOnClick: false
        });
        //add zoom control at our desired position
        L.control.zoom({
            position: "bottomright"
        }).addTo(map);
        //add Basemap to map
        L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
            maxZoom: 24,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        //function to return an icon based on the tukio category--- an alert is red, --- an event is blue
        function getIcon(category, latlng) {
            if (category == 'event') {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "/static/img/event.png",
                        iconSize: [23, 33],
                        popupAnchor: [0, 0]
                    })
                });
            } else {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "/static/img/circle.png",
                        iconSize: [23, 33],
                        popupAnchor: [0, 0]
                    })
                });
            }

        }
        //ajax function to fetch data from the server --as GeoJSON
        $.ajax({
            methods: "GET",
            url: '/api/tukios',//our api endpoint
            success: function (data) {
                // initialize a layer that takes the returned GeoJSON data
                tukio_layer = new L.GeoJSON(data, {

                    pointToLayer: function (feature, latlng) {
                        //determine if a tukio is an alert and then add a popup with a class for styling it uniquely
                        if (feature.properties.category == 'alert') {
                            pop_ = L.popup({className: 'popup-alert'})
                                    .setLatLng(latlng)
                                    .setContent(feature.properties.desc);
                        } else {
                            pop_ = L.popup({})
                                    .setLatLng(latlng)
                                    .setContent(feature.properties.desc);
                        }
                        //return a marker with popup and style information
                        return getIcon(feature.properties.category, latlng).bindPopup(pop_);
                    },
                    // this is a hack to  enable the alert tukios have their popup open on the initial load,--and it worked :)
                    //but I guess there is a better way than this, I jus needed it to work.
                    onEachFeature: function (feature, layer) {
                        var layer_cat = feature.properties.category;
                        var popupContent = feature.properties.desc;
                        if (layer_cat == 'alert') {
                            var pop = L.popup({className: 'popup-alert'})
                                    .setLatLng(layer.getLatLng())
                                    .setContent(popupContent);
                            map.addLayer(pop);
                        }

                    }
                });
                //add the tukio_layer now to the map
                map.addLayer(tukio_layer);
                // fit the map to the extent/bounds of the tukio layer
                map.fitBounds(tukio_layer.getBounds());
            }
        });
    </script>
{% endblock page-js %}